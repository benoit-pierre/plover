language: generic

matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
    - os: osx

before_install:
  - |
    case "$TRAVIS_OS_NAME" in
    osx)
      brew update &&
      brew install python --framework &&
      brew link --overwrite python &&
      brew install wxpython &&
      true
      ;;
    linux)
      sudo apt-add-repository -y ppa:adamwolf/kicad-trusty-backports &&
      sudo apt-get update -qq &&
      sudo apt-get install -y python-wxgtk3.0 python-xlib &&
      true
      ;;
    esac &&
    python setup.py develop --user --upgrade &&
    # Don't use a more recent version of mock or
    # we run into issues with setuptools and six...
    pip install --user --upgrade 'mock==1.0.1' pytest &&
    true

install: true

script:
  - depth=50; while ! git describe --tag '--match=v[0-9]*'; do depth=$(($depth+10)); git fetch --depth $depth; done
  - python setup.py patch_version
  - python setup.py test
  - |
    case "$TRAVIS_OS_NAME" in
    osx)
      make -C osx &&
      true
      ;;
    linux)
      python setup.py bdist_egg &&
      python setup.py bdist_wheel &&
      true
      ;;
    esac

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: "shMJ+98tAIA+ZvdqZQd/Kd4KIHGj73GGZYf/eVHlU2V6SV6vWEgleiJSHzxLOnjXoG8vx91+RdYPWIKNW/Jqo7TdY/Gdo65thvPfM6vLOUJn9m5HjgGbj684XNAspBFJwO9w1eJrEbMAduuOxKURoVY1DdivQ1C1dhElzSVsddY="
  file_glob: true
  file:
    - "dist/*.dmg"
    - "dist/*.egg"
    - "dist/*.whl"
  on:
    tags: true
    repo: benoit-pierre/plover
